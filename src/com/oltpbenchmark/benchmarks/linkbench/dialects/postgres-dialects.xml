<?xml version="1.0"?>
<dialects>
	<dialect type="POSTGRES">
		<procedure name="AddLink">
			<statement name="insertNoCount">INSERT INTO linktable (id1, id2, link_type, visibility, data, time, version) VALUES (?,?,?,?,HEXDATA,?,?) ON CONFLICT (id) DO UPDATE SET visibility = excluded.visibility</statement>
			<statement name="updateCount">INSERT INTO counttable (id, link_type, count, time, version) VALUES (?, ?, ?, ?, 0) ON CONFLICT (id) DO UPDATE SET count = excluded.count + ? , version = excluded.version + 1 , time = ?</statement>
			<statement name="updateData">UPDATE linktable SET visibility = ? , data = HEXDATA , time = ? , version = ? WHERE id1 = ? AND id2 = ? AND link_type = ?</statement>
        </procedure>
		<procedure name="AddNode">
			<statement name="addNode">INSERT INTO nodetable (type, version, time, data) VALUES (?,?,?,HEXDATA)</statement>
        </procedure>
		<procedure name="CountLink">
			<statement name="countStmt">select count from counttable where id = ? and link_type = ?</statement>
        </procedure>
		<procedure name="DeleteLink">
			<statement name="selectLink">SELECT visibility FROM linktable WHERE id1 = ? AND id2 = ? AND link_type = ? FOR UPDATE</statement>
			<statement name="deleteLink">DELETE FROM linktable  WHERE id1 = ? AND id2 = ? AND link_type = ?</statement>
			<statement name="hideLink">UPDATE linktable SET visibility =  ? WHERE id1 = ? AND id2 = ? AND link_type = ?</statement>
			<statement name="updateLink">INSERT INTO counttable (id, link_type, count, time, version)  VALUES (?, ?, 0, ?, 0)  ON CONFLICT (id) DO UPDATE SET count = IF (excluded.count = 0, 0, excluded.count - 1) , time = ?, version = excluded.version + 1</statement>
        </procedure>
		<procedure name="DeleteNode">
			<statement name="deleteStmt">DELETE FROM nodetable WHERE id= ? and type = ?</statement>
        </procedure>
		<procedure name="GetLink">
			<statement name="getLinkStmt">select id1, id2, link_type, visibility, data, time,  version from linktable  where id1 = ? and link_type = ?  and id2 in (?)</statement>
        </procedure>
		<procedure name="GetLinkList">
			<statement name="getLinkListsStmt">select id1, id2, link_type, visibility, data, time, version from  linktable  where id1 = ? and link_type = ? and time >= ? and time &lt;= ? and visibility = ? order by time desc  limit ?, ?</statement>
        </procedure>
		<procedure name="GetNode">
			<statement name="getNodeStmt">SELECT id, type, version, time, data FROM nodetable WHERE id= ?</statement>
        </procedure>
		<procedure name="UpdateNode">
			<statement name="updateNodeStmt">UPDATE nodetable SET version= ? , time= ? , data= HEXDATA WHERE id= ? AND type= ?</statement>
        </procedure>
	</dialect>
</dialects>
